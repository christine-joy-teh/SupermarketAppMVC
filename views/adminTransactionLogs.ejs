<%- include('partials/head', { pageTitle: 'Transaction Logs - Supermarket App' }) %>
<%- include('partials/navbar', {
  navLinksLeft: [
    { href: '/inventory', label: 'Inventory' },
    { href: '/addProduct', label: 'Add Product' },
    { href: '/admin/orders', label: 'Orders' },
    { href: '/admin/refunds', label: 'Refunds' },
    { href: '/admin/transactions', label: 'Transactions', active: true },
    { href: '/admin/users', label: 'Users' },
    { href: '/admin/promotion', label: 'Promotion' }
  ],
  navLinksRight: [
    { href: '/logout', label: 'Logout' }
  ]
}) %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <p class="text-uppercase text-muted small mb-1">Admin</p>
      <h3 class="mb-0">Transaction Logs</h3>
      <small class="text-muted">Append-only audit trail for payments, refunds, and points</small>
    </div>
  </div>

  <% if (success && success.length) { %>
    <div class="alert alert-success"><%= success[0] %></div>
  <% } %>
  <% if (error && error.length) { %>
    <div class="alert alert-danger"><%= error[0] %></div>
  <% } %>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action</th>
          <th>Alert</th>
          <th class="text-end">Prev</th>
          <th class="text-end">New</th>
          <th>Reference</th>
          <th class="text-center">Admin Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (logs && logs.length) { %>
          <% logs.forEach(log => { %>
            <tr class="<%= log.suspicious_flag ? 'table-warning' : '' %>">
              <td><%= log.created_at ? new Date(log.created_at).toLocaleString() : 'n/a' %></td>
              <td>
                <div class="d-flex flex-column">
                  <span class="fw-semibold"><%= log.userName || `User #${log.user_id}` %></span>
                  <small class="text-muted"><%= log.userEmail || '' %></small>
                </div>
              </td>
              <td><span class="badge bg-secondary text-uppercase"><%= log.action_type %></span></td>
              <td>
                <% if (log.suspicious_flag) { %>
                  <span class="badge bg-warning text-dark">Suspicious</span>
                  <div class="small text-muted"><%= log.suspicious_reason || 'Unusual activity' %></div>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
              <td class="text-end"><%= log.previous_balance !== null ? Number(log.previous_balance).toFixed(2) : '-' %></td>
              <td class="text-end"><%= log.new_balance !== null ? Number(log.new_balance).toFixed(2) : '-' %></td>
              <td><%= log.reference_id !== null ? log.reference_id : '-' %></td>
              <td class="text-center">
                <% if (log.suspicious_flag) { %>
                  <% if (log.userDisabled) { %>
                    <span class="badge bg-secondary">Disabled</span>
                  <% } else { %>
                    <form action="/admin/users/<%= log.user_id %>/disable" method="POST" class="d-inline">
                      <input type="hidden" name="disabled" value="1">
                      <button type="submit" class="btn btn-sm btn-outline-danger">Disable</button>
                    </form>
                  <% } %>
                <% } else { %>
                  <span class="text-muted">-</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="8" class="text-center text-muted">No transaction logs found.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <% if (pagination && pagination.totalPages > 1) { %>
    <nav class="mt-3" aria-label="Transactions pagination">
      <ul class="pagination justify-content-center mb-0">
        <li class="page-item <%= pagination.page <= 1 ? 'disabled' : '' %>">
          <a class="page-link" href="/admin/transactions?page=<%= pagination.page - 1 %>">Previous</a>
        </li>
        <% for (let p = 1; p <= pagination.totalPages; p++) { %>
          <li class="page-item <%= p === pagination.page ? 'active' : '' %>">
            <a class="page-link" href="/admin/transactions?page=<%= p %>"><%= p %></a>
          </li>
        <% } %>
        <li class="page-item <%= pagination.page >= pagination.totalPages ? 'disabled' : '' %>">
          <a class="page-link" href="/admin/transactions?page=<%= pagination.page + 1 %>">Next</a>
        </li>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('partials/footer') %>


