<% const paypalSdk = paypalClientId ? `<script src="https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=SGD"></script>` : ''; %>
<%- include('partials/head', { pageTitle: 'Membership Payment', extraHead: paypalSdk }) %>
<%- include('partials/navbar', {
  navLinksRight: user ? [
    { href: '/cart', label: 'Cart', badgeValue: cartCount, badgeClass: 'bg-primary', classes: 'position-relative' },
    { href: '/orders/history', label: 'My Orders' },
    { href: '/shopping', label: 'Shop' },
    { href: '/logout', label: 'Logout' }
  ] : [
    { href: '/register', label: 'Register' },
    { href: '/login', label: 'Login' }
  ]
}) %>

<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <% if (typeof success !== 'undefined' && success.length) { %>
        <div class="alert alert-success"><%= success[0] %></div>
      <% } %>
      <% if (typeof error !== 'undefined' && error.length) { %>
        <div class="alert alert-danger"><%= error[0] %></div>
      <% } %>

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-3">
        <div>
          <h3 class="mb-1">Choose your membership</h3>
          <% const currentPlan = (user && user.plan) ? String(user.plan).toLowerCase() : ''; %>
          <p class="text-muted mb-0">
            <% if (currentPlan) { %>
              Current plan: <strong><%= currentPlan.toUpperCase() %></strong>
            <% } else { %>
              No plan selected yet. Pick one below.
            <% } %>
          </p>
        </div>
        <% if (user) { %>
          <div class="badge bg-primary-subtle text-primary px-3 py-2 border">Signed in as <%= user.username || user.email || 'user' %></div>
        <% } %>
      </div>

      <div class="plan-row">
        <% Object.keys(plans || {}).forEach(function(key){ const p = plans[key]; const isSelected = planKey === key; const isCurrent = currentPlan === key; %>
          <div class="plan-card <%= isSelected ? 'plan-selected' : '' %>" data-plan="<%= key %>">
            <% if (key === 'silver') { %><div class="recommended">Recommended</div><% } %>
            <% if (key === 'gold') { %><div class="plan-badge">Best value</div><% } %>
            <div class="plan-name"><%= p.name %></div>
            <div class="plan-price"><%= p.priceLabel %></div>
            <div class="plan-features">
              <% (p.perks || []).forEach(function(perk){ %>
                <div><%= perk %></div>
              <% }); %>
            </div>
            <% if (user) { %>
              <a class="btn btn-<%= p.color %> btn-sm w-100 mt-auto <%= isCurrent ? 'disabled' : '' %>"
                 href="/membership/payment?plan=<%= key %>&confirm=1">
                <%= isCurrent ? 'Current plan' : ('Switch to ' + p.name) %>
              </a>
            <% } else { %>
              <form action="/register" method="GET" class="mt-auto">
                <input type="hidden" name="plan" value="<%= key %>">
                <button type="submit" class="btn btn-<%= p.color %> btn-sm w-100">
                  Choose <%= p.name %>
                </button>
              </form>
            <% } %>
          </div>
        <% }); %>
      </div>

      <% const showConfirm = user && (confirm === '1' || confirm === 1 || planKey); %>
      <% const selectedPlan = showConfirm ? (plans[planKey] || plans.silver) : null; %>
      <% const isPaid = selectedPlan ? Number(selectedPlan.amount) > 0 : false; %>
<<<<<<< HEAD
=======
      <% const walletAmount = typeof walletBalance !== 'undefined' ? Number(walletBalance || 0) : 0; %>
>>>>>>> bfc95a4 (new updates, transaction logs and refund)
      <% if (showConfirm) { %>
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1">Payment</h5>
                <div class="text-muted small mb-1">Selected plan: <strong><%= selectedPlan.name %></strong></div>
                <div class="text-muted small">Benefits: <%= (selectedPlan.perks || []).join(', ') %></div>
              </div>
              <div class="text-end">
                <div class="fs-5 fw-bold"><%= selectedPlan.priceLabel %></div>
                <small class="text-muted">Billed monthly</small>
              </div>
            </div>
            <% if (!isPaid) { %>
              <form action="/membership/payment" method="POST" class="mt-3">
                <input type="hidden" name="plan" value="<%= planKey %>">
                <div class="alert alert-info mt-3 mb-0">
                  No payment needed for Basic. Click confirm to switch plans.
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2 mt-3">
                  <a href="/shopping" class="btn btn-outline-secondary w-100">Back to shopping</a>
                  <button type="submit" class="btn btn-primary w-100">Confirm plan</button>
                </div>
              </form>
            <% } else { %>
              <div class="mt-4">
                <div class="text-muted small mb-2">Or pay with</div>
                <div class="d-flex flex-column flex-md-row gap-3">
                  <% if (paypalClientId) { %>
                    <div class="flex-fill">
                      <div id="membership-paypal-container" data-plan="<%= planKey %>"></div>
                    </div>
                  <% } else { %>
                    <div class="alert alert-warning flex-fill mb-0">
                      PayPal is not configured. Please use NETS or card instead.
                    </div>
                  <% } %>
                  <form action="/membership/nets/qr" method="POST" class="flex-fill">
                    <input type="hidden" name="plan" value="<%= planKey %>">
                    <button type="submit" class="btn btn-success w-100">Pay with NETS QR</button>
                  </form>
<<<<<<< HEAD
=======
                  <div class="flex-fill">
                    <div class="card card-body h-100">
                      <div class="text-muted small mb-1">E-wallet balance</div>
                      <div class="fw-semibold mb-2">$<%= walletAmount.toFixed(2) %></div>
                      <form action="/membership/wallet/pay" method="POST">
                        <input type="hidden" name="plan" value="<%= planKey %>">
                        <button type="submit" class="btn btn-dark w-100" <%= walletAmount < Number(selectedPlan.amount || 0) ? 'disabled' : '' %>>
                          Pay with E-wallet
                        </button>
                      </form>
                      <% if (walletAmount < Number(selectedPlan.amount || 0)) { %>
                        <div class="text-danger small mt-2">Insufficient wallet balance.</div>
                      <% } %>
                      <a href="/wallet/topup" class="btn btn-outline-secondary w-100 mt-2">Top up wallet</a>
                    </div>
                  </div>
>>>>>>> bfc95a4 (new updates, transaction logs and refund)
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2 mt-3">
                  <a href="/shopping" class="btn btn-outline-secondary w-100">Back to shopping</a>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>

      <div class="text-center mt-3">
        <% if (!user) { %>
          <small class="text-muted">Already have an account? <a href="/login">Sign in</a></small>
        <% } else { %>
          <div class="alert alert-warning d-inline-flex align-items-center py-2 px-3" role="alert">
            <strong class="me-2">Need to leave?</strong>
            <a href="/cart" class="alert-link">Back to cart</a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<% if (paypalClientId && showConfirm && isPaid) { %>
  <script>
    (function () {
      const container = document.getElementById('membership-paypal-container');
      if (!container || !window.paypal) return;
      const plan = container.getAttribute('data-plan');

      paypal.Buttons({
        createOrder: function () {
          return fetch('/paypal/membership/create-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plan: plan })
          })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              if (data.id) return data.id;
              throw new Error(data.error || 'Unable to create PayPal order.');
            });
        },
        onApprove: function (data) {
          return fetch('/paypal/membership/capture-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderId: data.orderID, plan: plan })
          })
            .then(function (res) { return res.json(); })
            .then(function (result) {
              if (result.redirect) {
                window.location.href = result.redirect;
                return;
              }
              if (result.error) {
                alert(result.error);
              }
            });
        },
        onError: function (err) {
          console.error(err);
          alert('PayPal payment failed. Please try again.');
        }
      }).render('#membership-paypal-container');
    })();
  </script>
<% } %>
<%- include('partials/footer') %>
