<% const paypalSdk = paypalClientId ? `<script src="https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=SGD"></script>` : ''; %>
<%- include('partials/head', { pageTitle: 'Payment - Supermarket App', extraHead: paypalSdk }) %>
<%- include('partials/navbar', {
  navLinksRight: [
    { href: '/cart', label: 'Cart', badgeValue: cartCount, badgeClass: 'bg-primary', classes: 'position-relative' },
    { href: '/orders/history', label: 'My Orders' },
    { href: '/shopping', label: 'Shop' },
    { href: '/logout', label: 'Logout' }
  ]
}) %>
  <div class="container mt-4">
    <% if (success && success.length) { %>
      <div class="alert alert-success"><%= success[0] %></div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error[0] %></div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mt-2">Payment</h2>
      <a href="/cart" class="btn btn-outline-secondary">Back to Cart</a>
    </div>

    <% if (!cart || cart.length === 0) { %>
      <p>Your cart is empty.</p>
      <a href="/shopping" class="btn btn-primary">Browse Products</a>
    <% } else { %>
      <div class="card bg-light border-0 shadow-sm mb-3">
        <div class="card-body">
          <% const orderSummary = (typeof summary !== 'undefined' && summary) ? summary : null; %>
          <% const promoDetails = orderSummary ? orderSummary.promo : null; %>
          <% const membership = orderSummary ? orderSummary.membership : null; %>
          <% const loyalty = orderSummary ? orderSummary.loyalty : null; %>
          <h6 class="text-uppercase text-muted small mb-2">Order summary</h6>
          <h5 class="mb-1">Subtotal: $<%= orderSummary ? orderSummary.totalBefore.toFixed(2) : '0.00' %></h5>
          <% if (promoDetails) { %>
            <div class="text-muted small">
              Promo: <%= promoDetails.percent ? promoDetails.percent : 0 %>% off
              <%= promoDetails.keywords ? promoDetails.keywords.join(', ') : 'selected items' %>
            </div>
            <% if (orderSummary && orderSummary.promoSavings > 0) { %>
              <div class="text-success">Promotion applied: -$<%= orderSummary.promoSavings.toFixed(2) %></div>
            <% } %>
          <% } %>
          <% if (membership && membership.percent > 0) { %>
            <div class="text-muted small">
              Membership: <%= membership.plan ? membership.plan.toUpperCase() : '' %> (<%= membership.percent %>% off)
            </div>
            <% if (membership.savings > 0) { %>
              <div class="text-success">Membership savings: -$<%= membership.savings.toFixed(2) %></div>
            <% } %>
          <% } %>
          <% if (loyalty && loyalty.savings > 0) { %>
            <div class="text-success"><%= loyalty.rewardLabel || 'Loyalty' %> savings: -$<%= loyalty.savings.toFixed(2) %></div>
          <% } %>
          <h4 class="mt-2">Total: $<%= orderSummary ? orderSummary.totalAfter.toFixed(2) : '0.00' %></h4>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-title mb-2">Loyalty points</h6>
          <% const pointsAvailable = loyalty ? Number(loyalty.pointsAvailable || 0) : 0; %>
          <% const pointsEarned = loyalty ? Number(loyalty.pointsEarned || 0) : 0; %>
          <% const maxRedeemPoints = loyalty ? Number(loyalty.maxRedeemPoints || 0) : 0; %>
          <% const appliedRedeemPoints = loyalty ? Number(loyalty.pointsSpent || 0) : 0; %>
          <div class="text-muted small mb-2">You have <strong><%= pointsAvailable %></strong> points. Pay with PayPal or NETS to earn <strong><%= pointsEarned %></strong> points.</div>
          <form action="/payment/loyalty" method="POST" class="mb-2">
            <label class="form-label">Redeem points (in 100s)</label>
            <input type="number" name="loyaltyRedeemPointsInput" id="loyalty-redeem-input" class="form-control" min="0" step="100" max="<%= maxRedeemPoints %>" value="<%= appliedRedeemPoints %>">
            <small class="text-muted">100 points = $1 off (up to 50% of your total).</small>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-outline-primary btn-sm" type="submit">Apply points</button>
              <span class="text-muted small">Total updates after applying.</span>
            </div>
          </form>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h6 class="card-title mb-2">E-wallet</h6>
          <% const walletAmount = typeof walletBalance !== 'undefined' ? Number(walletBalance || 0) : 0; %>
          <% const totalDue = orderSummary ? Number(orderSummary.totalAfter || 0) : 0; %>
          <div class="text-muted small mb-2">Balance: <strong>$<%= walletAmount.toFixed(2) %></strong></div>
          <div class="d-flex flex-column flex-md-row gap-2">
            <button
              id="wallet-pay-button"
              class="btn btn-outline-primary w-100"
              <%= (hasStockIssue || walletAmount < totalDue) ? 'disabled' : '' %>>
              Pay with E-wallet
            </button>
            <a href="/wallet/topup" class="btn btn-success w-100">Top up wallet</a>
          </div>
          <% if (walletAmount < totalDue && !hasStockIssue) { %>
            <div class="text-danger small mt-2">Insufficient wallet balance for this order.</div>
          <% } %>
        </div>
      </div>

      <form action="/nets/qr" method="POST">
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title mb-2">Delivery option</h6>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryMethod" id="delivery-home" value="delivery" checked>
              <label class="form-check-label" for="delivery-home">Deliver to my address</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryMethod" id="delivery-pickup" value="pickup">
              <label class="form-check-label" for="delivery-pickup">Self-collect / pickup</label>
            </div>
            <div id="delivery-address-block" class="mt-3">
              <label class="form-label">Delivery address</label>
              <textarea name="deliveryAddress" class="form-control" rows="2" placeholder="Street, unit number, postal code"></textarea>
              <small class="text-muted">Add an address even when picking up (for contact or alternate delivery).</small>
            </div>
            <div id="pickup-outlet-block" class="mt-3" style="display:none;">
              <label class="form-label">Pickup outlet</label>
              <select name="pickupOutlet" class="form-select">
                <option value="">Select an outlet</option>
                <option value="Woodlands">Woodlands</option>
                <option value="Punggol">Punggol</option>
                <option value="Orchard">Orchard</option>
              </select>
              <small class="text-muted">Choose where you'll collect your order.</small>
            </div>
          </div>
        </div>
        <input type="hidden" name="loyaltyRedeemPoints" id="loyalty-redeem-hidden" value="<%= loyalty ? loyalty.pointsSpent : 0 %>">
        <input type="hidden" name="cartTotal" value="<%= summary ? summary.totalAfter.toFixed(2) : '0.00' %>">
        <button class="btn btn-success w-100" <%= hasStockIssue ? 'disabled' : '' %>>Generate NETS QR</button>
        <% if (hasStockIssue) { %>
          <div class="mt-2 text-danger small">Some items are out of stock. Please remove them before checkout.</div>
        <% } %>
      </form>

      <% if (typeof netsError !== 'undefined' && netsError) { %>
        <div class="alert alert-danger mt-3">
          <h5 class="mb-1"><%= netsError.title || 'Error' %></h5>
          <div class="small">Response code: <%= netsError.responseCode || 'N.A.' %></div>
          <% if (netsError.instructions) { %>
            <div class="small mt-1"><%= netsError.instructions %></div>
          <% } %>
          <div class="mt-2"><%= netsError.errorMsg || 'Unable to generate NETS QR code.' %></div>
        </div>
      <% } %>

      <% if (typeof netsQr !== 'undefined' && netsQr) { %>
        <div class="mt-4">
          <h2 class="mt-2"><%= netsQr.title || 'Scan the QR Code' %></h2>
          <p class="text-muted">Scan with your bank simulator app to complete payment.</p>
          <div class="mt-3">
            <img src="<%= netsQr.qrCodeUrl %>" alt="NETS QR Code" style="max-width: 260px; width: 100%;">
          </div>
          <div class="mt-2">
            Time remaining: <span id="nets-timer"></span>
          </div>
          <% if (netsQr.txnRetrievalRef) { %>
            <div class="text-muted small mt-2">Reference: <%= netsQr.txnRetrievalRef %></div>
          <% } %>
          <form action="/nets/confirm" method="POST" class="mt-3">
            <input type="hidden" name="loyaltyRedeemPoints" value="<%= loyalty ? loyalty.pointsSpent : 0 %>">
            <button class="btn btn-primary" type="submit">Confirm NETS payment</button>
          </form>
          <div class="mt-4">
            <a href="/payment">Cancel</a>
          </div>
        </div>
      <% } %>

      <% if (paypalClientId && !hasStockIssue) { %>
        <div class="mt-3">
          <div class="text-muted small mb-2">Or pay with PayPal</div>
          <div id="paypal-button-container"></div>
        </div>
      <% } %>
    <% } %>
  </div>
<script>
  (function(){
    const delivery = document.getElementById('delivery-home');
    const pickup = document.getElementById('delivery-pickup');
    const addressBlock = document.getElementById('delivery-address-block');
    const outletBlock = document.getElementById('pickup-outlet-block');
    const loyaltyInput = document.getElementById('loyalty-redeem-input');
    const walletPayBtn = document.getElementById('wallet-pay-button');
    const loyaltyTarget = document.getElementById('loyalty-redeem-hidden');
    function toggleSections(){
      const isPickup = pickup && pickup.checked;
      if (outletBlock) outletBlock.style.display = isPickup ? 'block' : 'none';
      if (addressBlock) addressBlock.style.display = isPickup ? 'none' : 'block';
    }
    if (delivery) delivery.addEventListener('change', toggleSections);
    if (pickup) pickup.addEventListener('change', toggleSections);
    toggleSections();
    if (loyaltyInput) {
      const clampRedeem = () => {
        const max = Number(loyaltyInput.max) || 0;
        let value = Math.max(0, Math.floor(Number(loyaltyInput.value) || 0));
        value = Math.min(value, max);
        value = Math.floor(value / 100) * 100;
        loyaltyInput.value = value;
      };
      loyaltyInput.addEventListener('input', clampRedeem);
      clampRedeem();
    }

    function getDeliveryDetails() {
      const deliveryMethod = pickup && pickup.checked ? 'pickup' : 'delivery';
      const addressInput = document.querySelector('textarea[name="deliveryAddress"]');
      const outletSelect = document.querySelector('select[name="pickupOutlet"]');
      return {
        deliveryMethod,
        deliveryAddress: addressInput ? addressInput.value : '',
        pickupOutlet: outletSelect ? outletSelect.value : ''
      };
    }

    if (walletPayBtn) {
      walletPayBtn.addEventListener('click', function () {
        const details = getDeliveryDetails();
        fetch('/wallet/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            loyaltyRedeemPoints: loyaltyTarget ? loyaltyTarget.value : 0,
            deliveryMethod: details.deliveryMethod,
            deliveryAddress: details.deliveryAddress,
            pickupOutlet: details.pickupOutlet
          })
        })
          .then(function (res) { return res.json(); })
          .then(function (result) {
            if (result.redirect) {
              window.location.href = result.redirect;
              return;
            }
            if (result.error) {
              alert(result.error);
            }
          });
      });
    }
  })();
</script>
<% if (paypalClientId) { %>
  <script>
    (function () {
      const container = document.getElementById('paypal-button-container');
      const loyaltyTarget = document.getElementById('loyalty-redeem-hidden');
      if (!window.paypal) return;

      function getDeliveryDetails() {
        const pickup = document.getElementById('delivery-pickup');
        const deliveryMethod = pickup && pickup.checked ? 'pickup' : 'delivery';
        const addressInput = document.querySelector('textarea[name="deliveryAddress"]');
        const outletSelect = document.querySelector('select[name="pickupOutlet"]');
        return {
          deliveryMethod,
          deliveryAddress: addressInput ? addressInput.value : '',
          pickupOutlet: outletSelect ? outletSelect.value : ''
        };
      }

      if (container && !<%= hasStockIssue ? 'true' : 'false' %>) {
        paypal.Buttons({
          createOrder: function () {
            const payload = { loyaltyRedeemPoints: loyaltyTarget ? loyaltyTarget.value : 0 };
            return fetch('/paypal/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            })
              .then(function (res) { return res.json(); })
              .then(function (data) {
                if (data.id) return data.id;
                throw new Error(data.error || 'Unable to create PayPal order.');
              });
          },
          onApprove: function (data) {
            const details = getDeliveryDetails();
            return fetch('/paypal/capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                orderId: data.orderID,
                loyaltyRedeemPoints: loyaltyTarget ? loyaltyTarget.value : 0,
                deliveryMethod: details.deliveryMethod,
                deliveryAddress: details.deliveryAddress,
                pickupOutlet: details.pickupOutlet
              })
            })
              .then(function (res) { return res.json(); })
              .then(function (result) {
                if (result.redirect) {
                  window.location.href = result.redirect;
                  return;
                }
                if (result.error) {
                  alert(result.error);
                }
              });
          },
          onError: function (err) {
            console.error(err);
            alert('PayPal payment failed. Please try again.');
          }
        }).render('#paypal-button-container');
      }

    })();
  </script>
<% } %>
<% if (typeof netsQr !== 'undefined' && netsQr) { %>
  <script>
    (function () {
      var totalSeconds = Number('<%= netsQr.timer || 300 %>');
      var el = document.getElementById('nets-timer');
      function tick() {
        var minutes = Math.floor(totalSeconds / 60);
        var seconds = totalSeconds % 60;
        el.textContent = minutes + ':' + String(seconds).padStart(2, '0');
        if (totalSeconds > 0) {
          totalSeconds -= 1;
          return;
        }
        window.location.href = '/nets-qr/fail';
      }
      if (el) {
        tick();
        setInterval(tick, 1000);
      }
    })();
  </script>
<% } %>
<%- include('partials/footer') %>
