<%- include('partials/head', { pageTitle: 'Request Refund - Supermarket App' }) %>
<%- include('partials/navbar', {
  navLinksRight: [
    { href: '/shopping', label: 'Shop' },
    { href: '/cart', label: 'Cart', badgeValue: cartCount, badgeClass: 'bg-primary' },
    { href: '/orders/history', label: 'My Orders', active: true },
    { href: '/logout', label: 'Logout' }
  ]
}) %>

<div class="container py-4" style="max-width: 720px;">
  <h3 class="mb-3">Request refund</h3>

  <% if (success && success.length) { %>
    <div class="alert alert-success"><%= success[0] %></div>
  <% } %>
  <% if (error && error.length) { %>
    <div class="alert alert-danger"><%= error[0] %></div>
  <% } %>

  <div class="card mb-3">
    <div class="card-body">
      <h6 class="text-uppercase text-muted small mb-2">Order summary</h6>
      <div class="d-flex justify-content-between">
        <span>Order #<%= order.id %></span>
        <span class="fw-semibold">$<%= Number(order.total || 0).toFixed(2) %></span>
      </div>
      <div class="text-muted small">Placed: <%= order.createdAt ? new Date(order.createdAt).toLocaleString() : 'n/a' %></div>
      <div class="text-muted small mt-1">Our refunds do not support NETS payments.</div>
    </div>
  </div>

  <form id="refund-form" action="/refunds" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="orderId" value="<%= order.id %>">
    <input type="hidden" name="refundItems" id="refundItemsInput">
    <div class="mb-3">
      <label class="form-label">Reason for refund</label>
      <textarea name="reason" class="form-control" rows="4" required placeholder="Describe the issue and what went wrong."></textarea>
    </div>
    <% if (orderItems && orderItems.length) { %>
      <div class="mb-3">
        <label class="form-label">Select items to refund (leave blank for full refund)</label>
        <div class="list-group">
          <% orderItems.forEach(item => { %>
            <div class="list-group-item d-flex align-items-center gap-3">
              <input class="form-check-input refund-item-toggle" type="checkbox" data-item-id="<%= item.id %>">
              <div class="flex-grow-1">
                <div class="fw-semibold"><%= item.name %></div>
                <small class="text-muted">Unit $<%= Number(item.unit_price || 0).toFixed(2) %> - Purchased <%= item.qty %> - Refundable <%= item.availableQty %></small>
              </div>
              <input
                type="number"
                class="form-control refund-item-qty"
                min="1"
                max="<%= item.availableQty %>"
                value="<%= item.availableQty %>"
                data-item-id="<%= item.id %>"
                style="max-width: 120px;"
                disabled
              >
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
    <div class="mb-3">
      <label class="form-label">Refund destination</label>
      <select name="refundDestination" class="form-select">
        <option value="E_WALLET">E-wallet</option>
        <option value="ORIGINAL_METHOD">Original payment method</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Attach document (optional)</label>
      <input type="file" name="document" class="form-control" accept=".jpg,.jpeg,.png,.pdf">
      <small class="text-muted">Receipts or photos help speed up the review.</small>
    </div>
    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">Submit request</button>
      <a href="/orders/history" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>
<script>
  (function () {
    const form = document.getElementById('refund-form');
    const itemsInput = document.getElementById('refundItemsInput');
    if (!form || !itemsInput) return;
    const toggles = Array.from(document.querySelectorAll('.refund-item-toggle'));
    const qtyInputs = Array.from(document.querySelectorAll('.refund-item-qty'));

    toggles.forEach(toggle => {
      toggle.addEventListener('change', () => {
        const id = toggle.getAttribute('data-item-id');
        const qtyInput = qtyInputs.find(input => input.getAttribute('data-item-id') === id);
        if (qtyInput) qtyInput.disabled = !toggle.checked;
      });
    });

    form.addEventListener('submit', () => {
      const items = [];
      toggles.forEach(toggle => {
        if (!toggle.checked) return;
        const id = toggle.getAttribute('data-item-id');
        const qtyInput = qtyInputs.find(input => input.getAttribute('data-item-id') === id);
        const qty = qtyInput ? Number(qtyInput.value) : 0;
        if (id && Number.isFinite(qty) && qty > 0) {
          items.push({ orderItemId: Number(id), refundQty: qty });
        }
      });
      itemsInput.value = JSON.stringify(items);
    });
  })();
</script>
<%- include('partials/footer') %>
